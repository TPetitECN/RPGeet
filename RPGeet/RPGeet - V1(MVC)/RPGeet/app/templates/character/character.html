{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sheet.css') }}">
{% endblock %}

{% block content %}
<!-- <div style="background: #ffe; border: 1px solid #ee9; padding: 10px; margin-bottom: 10px; font-family: monospace;">
    DEBUG STATS: {{ stats }} <br> DEBUG CHAR: {{ character }}
</div> -->
<a href="{{ url_for('game.view_game', game_id=game_id) }}">Back to Game</a>

<form method="POST" action="{{ url_for('character.save_character', game_id=game_id, character_id=character_id) }}">
    <div style="position: sticky; top: 10px; z-index: 100; text-align: right; margin-bottom: 10px;">
        <button type="submit" style="background: var(--success-color); font-size: 1.2rem; padding: 10px 20px;">Save Character</button>
    </div>

    {% set character = stats %}
    <div class="sheet-container">
        <div class="sheet-header">
            <div class="header-row">
                <div class="field-group">
                    <label for="name">Character Name / Nom du personnage</label>
                    <input type="text" id="name" name="name" value="{{ character.name }}">
                </div>
                <div class="field-group">
                    <label for="player">Player / Joueur</label>
                    <input type="text" id="player" name="player" value="{{ character.player }}">
                </div>
            </div>
            <!-- ... rest of header ... -->
            <!-- To match the existing structure, we just wrap the whole thing. 
                 The rest of the content is unchanged but indented in the form.
                 Using a simpler replace strategy to avoid re-pasting the whole file. -->
            <div class="header-row">
                <div class="field-group">
                    <label for="class_level">Class & Level / Classes & Niveaux</label>
                    <!-- Note: Classes are not editable via simple input yet in logic, but let's keep it -->
                    <input type="text" id="class_level" name="class_level" value="{{ character.class_level }}" list="classes" readonly>
                    <!-- Removing datalist for simplicity or keeping it if we implement class editing later -->
                </div>
                <div class="field-group">
                    <label for="race">Race</label>
                    <input type="text" id="race" name="race" value="{{ character.race }}" readonly>
                </div>
                <div class="field-group">
                    <label for="alignment">Alignment / Religion</label>
                    <input type="text" id="alignment" name="alignment" value="{{ character.alignment }}">
                </div>
                 <div class="field-group">
                    <label for="deity">Deity / Divinité</label>
                     <input type="text" id="deity" name="deity" value="{{ character.deity }}" readonly>
                </div>
            </div>
            <div class="header-row">
                 <div class="field-group small">
                    <label for="age">Age</label>
                    <input type="text" id="age" name="age" value="{{ character.age }}">
                </div>
                 <div class="field-group small">
                    <label for="gender">Gender / Sexe</label>
                    <input type="text" id="gender" name="gender" value="{{ character.gender }}">
                </div>
                 <div class="field-group small">
                    <label for="height">Height / Taille</label>
                    <input type="text" id="height" name="height" value="{{ character.height }}">
                </div>
                 <div class="field-group small">
                    <label for="weight">Weight / Poids</label>
                    <input type="text" id="weight" name="weight" value="{{ character.weight }}">
                </div>
                 <div class="field-group">
                    <label for="eyes">Eyes / Yeux</label>
                    <input type="text" id="eyes" name="eyes" value="{{ character.eyes }}">
                </div>
                 <div class="field-group">
                    <label for="hair">Hair / Cheveux</label>
                    <input type="text" id="hair" name="hair" value="{{ character.hair }}">
                </div>
            </div>
        </div>

        <div class="sheet-main">
            <div class="column left-column">
                <!-- Attributes -->
                <section class="attributes">
                    <h3>Abilities / Caractéristiques</h3>
                    <div class="attribute-header">
                        <span>Score</span>
                        <span>Name</span>
                        <span>Mod</span>
                    </div>
                    {% for attr in character.attributes %}
                    <div class="attribute-row">
                        <div class="score-input">
                            <button type="button" class="btn-minus" onclick="adjustValue('{{ attr.key }}_score', -1)">-</button>
                            <input type="number" id="{{ attr.key }}_score" name="{{ attr.key }}_score" value="{{ attr.score }}">
                            <button type="button" class="btn-plus" onclick="adjustValue('{{ attr.key }}_score', 1)">+</button>
                        </div>
                        <span class="attr-name">{{ attr.name }}</span>
                        <div class="mod-display">
                            <input type="text" id="{{ attr.key }}_mod" name="{{ attr.key }}_mod" value="{{ attr.mod }}" readonly class="readonly-mod">
                        </div>
                    </div>
                    {% endfor %}
                </section>
                
                <!-- HP -->
                <section class="hp-section">
                    <h3>Hit Points / Points de vie</h3>
                     <div class="field-group">
                        <label>Total HP</label>
                         <div class="score-input">
                            <button type="button" class="btn-minus" onclick="adjustValue('hp_total', -1)">-</button>
                            <input type="number" id="hp_total" name="hp_total" value="{{ character.hp_total }}">
                            <button type="button" class="btn-plus" onclick="adjustValue('hp_total', 1)">+</button>
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Current HP</label>
                         <div class="score-input">
                            <button type="button" class="btn-minus" onclick="adjustValue('hp_current', -1)">-</button>
                            <input type="number" id="hp_current" name="hp_current" value="{{ character.hp_current }}">
                            <button type="button" class="btn-plus" onclick="adjustValue('hp_current', 1)">+</button>
                        </div>
                    </div>
                     <div class="field-group">
                        <label>Non-Lethal / Non-létaux</label>
                        <input type="text" name="hp_nonlethal" value="{{ character.hp_nonlethal }}">
                    </div>
                </section>
            </div>

            <div class="column center-column">
                <!-- Combat Stats -->
                 <section class="combat-stats">
                    <div class="stat-box">
                        <label>AC / CA</label>
                        <input type="number" name="ac_total" value="{{ character.ac_total }}" readonly>
                    </div>
                     <div class="stat-box">
                        <label>Touch / Contact</label>
                        <input type="number" name="ac_touch" value="{{ character.ac_touch }}" readonly>
                    </div>
                     <div class="stat-box">
                        <label>Flat-footed / Surpris</label>
                        <input type="number" name="ac_flat" value="{{ character.ac_flat }}" readonly>
                    </div>
                     <div class="stat-box">
                        <label>Initiative</label>
                         <div class="score-input">
                             <input type="number" name="initiative" value="{{ character.initiative }}" readonly>
                         </div>
                    </div>
                 </section>

                 <!-- Saves -->
                 <section class="saves">
                     <h3>Saving Throws / Sauvegardes</h3>
                     <div class="save-header">
                         <span>Save</span>
                         <span>Total</span>
                         <span>Base</span>
                         <span>Ability</span>
                         <span>Magic</span>
                         <span>Misc</span>
                     </div>
                     {% for save in character.saves %}
                     <div class="save-row">
                         <span class="save-name">{{ save.name }}</span>
                         <input type="number" name="{{ save.key }}_total" value="{{ save.total }}" readonly>
                         <input type="number" name="{{ save.key }}_base" value="{{ save.base }}" readonly>
                         <input type="number" name="{{ save.key }}_ability" value="{{ save.ability }}" readonly>
                         <!-- Allow editing magic/misc later -->
                         <input type="number" name="{{ save.key }}_magic" value="{{ save.magic }}" readonly>
                         <input type="number" name="{{ save.key }}_misc" value="{{ save.misc }}" readonly>
                     </div>
                     {% endfor %}
                 </section>

                 <!-- BAB / CMB / CMD -->
                 <section class="combat-maneuvers">
                     <div class="stat-row">
                         <label>BAB / BBA</label>
                         <input type="number" name="bab" value="{{ character.bab }}" readonly>
                     </div>
                     <div class="stat-row">
                         <label>CMB / BMO</label>
                         <input type="number" name="cmb" value="{{ character.cmb }}" readonly>
                     </div>
                     <div class="stat-row">
                         <label>CMD / DMD</label>
                         <input type="number" name="cmd" value="{{ character.cmd }}" readonly>
                     </div>
                 </section>
            </div>
            
             <div class="column right-column">
                <!-- Skills (Simplified) -->
                <section class="skills">
                    <h3>Skills / Compétences</h3>
                     <div class="skill-list">
                         <div class="skill-header-row">
                             <span class="hdr-class">C</span>
                             <span class="hdr-name">Skill</span>
                             <span class="hdr-total">Total</span>
                             <span class="hdr-eq">=</span>
                             <span class="hdr-mod">Mod</span>
                             <span class="hdr-plus">+</span>
                             <span class="hdr-ranks">Rnk</span>
                             <span class="hdr-plus">+</span>
                             <span class="hdr-misc">Msc</span>
                         </div>
                         {% for skill in character.skills %}
                         <div class="skill-row" data-ability="{{ skill.ability }}" data-key="{{ skill.key }}">
                             <input type="checkbox" name="{{ skill.key }}_class" {% if skill.is_class %}checked{% endif %} class="skill-class-cb">
                             <span class="skill-name">{{ skill.name }} <small>({{ skill.ability|upper }})</small></span>
                             <input type="number" class="skill-total" name="{{ skill.key }}_total" readonly>
                             <span class="eq">=</span>
                             <input type="text" class="skill-abil-mod" readonly>
                             <span class="plus">+</span>
                             <input type="number" class="skill-ranks input-small" name="{{ skill.key }}_ranks" value="{{ skill.ranks }}">
                             <span class="plus">+</span>
                             <input type="number" class="skill-misc input-small" name="{{ skill.key }}_misc" value="{{ skill.misc }}">
                         </div>
                         {% endfor %}
                     </div>
                </section>
            </div>
        </div>
        
        <!-- Weapons -->
        <section class="weapons">
            <h3>Weapons / Armes</h3>
            <table>
                <thead>
                    <tr>
                        <th>Weapon</th>
                        <th>Attack Bonus</th>
                        <th>Damage</th>
                        <th>Critical</th>
                        <th>Range</th>
                        <th>Type</th>
                        <th>Ammo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for weapon in character.weapons %}
                    <tr>
                        <td><input type="text" name="weapon_{{ loop.index }}_name" value="{{ weapon.name }}"></td>
                        <td><input type="text" name="weapon_{{ loop.index }}_attack" value="{{ weapon.attack }}"></td>
                        <td><input type="text" name="weapon_{{ loop.index }}_damage" value="{{ weapon.damage }}"></td>
                        <td><input type="text" name="weapon_{{ loop.index }}_crit" value="{{ weapon.crit }}"></td>
                        <td><input type="text" name="weapon_{{ loop.index }}_range" value="{{ weapon.range }}"></td>
                        <td><input type="text" name="weapon_{{ loop.index }}_type" value="{{ weapon.type }}"></td>
                        <td><input type="text" name="weapon_{{ loop.index }}_ammo" value="{{ weapon.ammo }}"></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/character_sheet.js') }}"></script>
{% endblock %}